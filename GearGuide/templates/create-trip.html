{% extends "base.html" %}
{% block title %}Plan a Trip · {{ app_name or 'GearGuide' }}{% endblock %}
{% block content %}
<section class="center-col">
  <p class="kicker">Plan</p>
  <h1>Plan a Trip</h1>

  <div class="card">
    <form method="post" action="{{ url_for('main.create_trip') }}" autocomplete="off">
      <div class="field">
        <label for="name">Trip Name</label>
        <input id="name" name="name" placeholder="Blue Ridge Weekend" required>
      </div>

      <div class="field" style="position:relative">
        <label for="destination">Location</label>
        <input id="destination" name="destination" placeholder="e.g., Charlotte, NC" aria-autocomplete="list" aria-haspopup="listbox" aria-expanded="false">
        <!-- suggestions -->
        <ul id="dest-suggestions" class="suggestions" role="listbox" style="display:none;"></ul>
      </div>

      <div class="field">
        <label>Dates</label>
        <div style="display:flex; gap:10px">
          <input type="date" id="start_date" name="start_date" required>
          <input type="date" id="end_date" name="end_date" required>
        </div>
        <small class="muted">Start and end dates cannot be in the past.</small>
      </div>

      <div class="field">
        <label for="activities">Activities</label>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <label><input type="checkbox" name="activities" value="Hiking"> Hiking</label>
          <label><input type="checkbox" name="activities" value="Camping"> Camping</label>
          <label><input type="checkbox" name="activities" value="Fishing"> Fishing</label>
          <label><input type="checkbox" name="activities" value="Kayaking"> Kayaking</label>
          <label><input type="checkbox" name="activities" value="Biking"> Biking</label>
          <label><input type="checkbox" name="activities" value="Swimming"> Swimming</label>
          <label><input type="checkbox" name="activities" value="Canoeing"> Canoeing</label>
          <label><input type="checkbox" name="activities" value="Climbing"> Climbing</label>
        </div>
      </div>

      <div class="field">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="4" placeholder="Optional details…"></textarea>
      </div>

      <div class="field">
        <button class="btn accent" type="submit">Create Trip</button>
      </div>
    </form>
  </div>
</section>



<script>
  // ---- Date constraints: no past dates; end >= start ----
  const todayISO = new Date().toISOString().split("T")[0];
  const startEl = document.getElementById("start_date");
  const endEl   = document.getElementById("end_date");

  // set mins to today
  startEl.min = todayISO;
  endEl.min   = todayISO;

  // whenever start changes, push end min up
  startEl.addEventListener("change", () => {
    const s = startEl.value || todayISO;
    endEl.min = s;
    if (endEl.value && endEl.value < s) endEl.value = s;
  });

  // ---- Lightweight location autocomplete (OpenStreetMap Nominatim) ----
  const destInput = document.getElementById('destination');
  const list = document.getElementById('dest-suggestions');
  let debounce;

  destInput.addEventListener('input', () => {
    const q = destInput.value.trim();
    destInput.setAttribute('aria-expanded', q ? 'true' : 'false');
    clearTimeout(debounce);
    if (!q) { list.style.display = 'none'; list.innerHTML=''; return; }
    debounce = setTimeout(() => searchPlaces(q), 400);
  });

  // keep list clickable when input loses focus
  destInput.addEventListener('blur', () => setTimeout(() => { list.style.display = 'none'; }, 150));

  async function searchPlaces(q) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        list.style.display = 'none';
        list.innerHTML = '';
        return;
      }

      list.innerHTML = data.map(item => {
        const a = item.address || {};
        const city = a.city || a.town || a.village || a.hamlet || a.suburb || a.municipality || '';
        const region = a.state || a.county || '';
        const country = a.country || '';
        const pretty = [city, region, country].filter(Boolean).join(', ') || item.display_name;
        return `<li data-val="${escapeHtml(pretty)}" role="option">${escapeHtml(pretty)}</li>`;
      }).join('');

      list.style.display = 'block';

      Array.from(list.querySelectorAll('li')).forEach(li => {
        li.addEventListener('mousedown', () => {
          destInput.value = li.getAttribute('data-val');
          list.style.display = 'none';
          destInput.setAttribute('aria-expanded', 'false');
        });
      });
    } catch {
      list.style.display = 'none';
      list.innerHTML = '';
    }
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
</script>
{% endblock %}